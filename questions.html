<html>
<head>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
 <script src="lib/modernizr-2.0.6.js" type="text/javascript"></script>
 <script src="lib/jqote2.js" type="text/javascript"></script>

 <script type="text/x-jqote-template" id="question">
     <![CDATA[
       <label for="<%=this.key%>"><%=this.text%></label>
       <select class="question" id="<%=this.key%>">
       <option value="">-- Select an answer --</option>
       <option value="1">Yes</option>
       <option value="0">No</option>
       </select><br/>
     ]]>
 </script>


</head>
<body>
<div id="questions"></div>

<div id="apis"></div>

<script>
$(document).ready(function() {
  var corpus;
  var questions;
  jQuery.getJSON('data/corpus.json', function(data){
    corpus = data;
    renderApis(corpus);
  });

  jQuery.getJSON('data/questions.json', function(data){
    questions = data;
    renderQuestions(questions);
  });
  
  $('.question').each(function() {
    $(this).val( localStorage['apiDateUser.' + $(this).attr('id')]);
  });
  
  $('.question').live('change', function() {
    localStorage['apiDateUser.' + $(this).attr('id')] = $(this).val();
    renderApis(corpus);
  });
  
  
});

function renderQuestions(questionList) {
  $.each(questionList, function(key, text) {
    $('#questions').append($('#question').jqote({key: key, text: text}));
  });
}

function renderApis(apilist) {
  var attributelist = new Object;
  var apirating = new Object;
  var retvals = new Object;

  // determine the global sutability rating for each api
  $.each(apilist, function(key, val) {
    var rating = checkData(key, val, attributelist);
    apirating[key] = rating;
  });
  
  $.each(attributelist, function(attribute, apis) {

    // for each attribute, sort the api list by their global suitability
    apis = apis.sort(function(a,b) {
      return apirating[b] - apirating[a];
    });
    
    // filter down to only the top-ranked apis for each attribute
    // and de-duplicate
    var maxval = -1;
    $.each(apis, function(index, api) {
      if(-1 == maxval) {
        maxval = apirating[api];
      }
      if(maxval == apirating[api]) {
        retvals[api] = apirating[api];
      }
    });
  });
  
  $('#apis').html('');
  $('#apis').append('<ul>');  
  $.each(retvals, function(api, rating) {
    $('#apis').append('<li>' + api + ' - ' + rating + '</li>');
  });
  $('#apis').append('</ul>');
}

// sloppily rates the different api matchups by category
function checkData(apiname, api, attributelist) {
  var rating = 0;
  $.each(api, function(attribute, val) {
    
    // retrieve the user's response to this question
    var userAttribute = (localStorage['apiDateUser.' + attribute])
    if(userAttribute && (userAttribute == val)) {
      rating += 1;

      // append to list of apis for this attribute
      if(!attributelist[attribute]) {
        attributelist[attribute] = new Array();
      }
      attributelist[attribute].push(apiname);
    }
  });
  return rating;
}

if (Modernizr.localstorage) {
  // window.localStorage is available!
} else {
  console.log("window.localStorage isn't available!")
  // no native support for HTML5 storage :(
  // maybe try dojox.storage or a third-party solution
}

</script>
</body>
</html>