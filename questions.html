<html>
<head>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
 <script src="lib/modernizr-2.0.6.js" type="text/javascript"></script>
</head>
<body>
<form method="POST">
<label for="Social">Do you need to send socials to your users or customers?</label>
<select class="question" id="Social">
<option value="">-- Select an answer --</option>
<option value="1">Yes</option>
<option value="0">No</option>
</select>

<label for="Events">Do you need to use events in your application?</label>
<select class="question" id="Events">
<option value="">-- Select an answer --</option>
<option value="1">Yes</option>
<option value="0">No</option>
</select>
</form>

<label for="Maps">Do you need to use maps in your application?</label>
<select class="question" id="Maps">
<option value="">-- Select an answer --</option>
<option value="1">Yes</option>
<option value="0">No</option>
</select>
</form>


<div id="apis"></div>

<script>
$(document).ready(function() {
  var corpus;
  jQuery.getJSON('data/corpus.json', function(data){
    corpus = data;
    console.log(data);
    
    renderApis(corpus);
  });
  
  $('.question').each(function() {
    console.log($(this).attr('id') + ": " + localStorage['apiDateUser.' + $(this).attr('id')]);
    $(this).val( localStorage['apiDateUser.' + $(this).attr('id')]);
  });
  
  $('.question').change(function() {
    localStorage['apiDateUser.' + $(this).attr('id')] = $(this).val();
    renderApis(corpus);
  });
  
  
});

function renderApis(apilist) {
  $('#apis').html('');
  $('#apis').append('<ul>');
  var attributelist = new Object;
  var apirating = new Object;
  $.each(apilist, function(key, val) {
    var rating = checkData(key, val, attributelist);
    apirating[key] = rating;
  });
  
  var retvals = new Object;
  
  $.each(attributelist, function(attribute, apis) {
    apis = apis.sort(function(a,b) {
      return apirating[b] - apirating[a];
    });

    var maxval = -1;
    $.each(apis, function(index, api) {
      if(-1 == maxval) {
        maxval = apirating[api];
      }
      if(maxval == apirating[api]) {
        retvals[api] = apirating[api];
      }
    });
  });
  
  
  $.each(retvals, function(api, rating) {
    $('#apis').append('<li>' + api + ' - ' + rating + '</li>');
  });
  
  $('#apis').append('</ul>');
}


// hash of API -> score
// each question adds to score
// create list of apis that are > 0 for each given question
// sort by the global rating

function checkData(apiname, api, attributelist) {
  var rating = 0;
  $.each(api, function(attribute, val) {
    var userAttribute = (localStorage['apiDateUser.' + attribute])
    if((userAttribute) && (userAttribute == val)) {
      rating += 1;

      if(!attributelist[attribute]) {
        attributelist[attribute] = new Array();
      }
      attributelist[attribute].push(apiname);

      // append to list of apis for this attribute
    }
  });
  return rating;
}

if (Modernizr.localstorage) {
  // window.localStorage is available!
} else {
  console.log("window.localStorage isn't available!")
  // no native support for HTML5 storage :(
  // maybe try dojox.storage or a third-party solution
}

</script>
</body>
</html>